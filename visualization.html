<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TraceChain - Advanced Supply Chain Optimization</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/currency.js@2.0.4/dist/currency.min.js"></script>
    <script src="https://unpkg.com/leaflet-geosearch@3.0.0/dist/geosearch.umd.js"></script>
    <style>
        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --secondary: #3b82f6;
            --dark: #1e293b;
            --light: #f8fafc;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
            min-height: 100vh;
            overflow-x: hidden;
            color: #1e293b;
        }

        .nav-glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.18);
        }

        .form-card, .map-container {
            opacity: 1 !important;
            transform: none !important;
        }

        .input-field {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(209, 213, 219, 0.5);
            transition: all 0.3s ease;
        }

        .input-field:focus {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }

        .route-option {
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        .route-option:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .optimal-route {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        .moving-truck {
            position: absolute;
            width: 24px;
            height: 24px;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMTA5OTgxIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PHBhdGggZD0iTTE2IDNIM20xOCAwaC0zbTAgMTBoLTNtLTEwIDBIM20xOCA3aC0zbS0xNCAwaC0zbTE0LTdoLTNtLTE0IDBIM20xOCAxM2gtM20tMTQgMGgtM20xOC03aC0zbS0xNCAwaC0zIi8+PC9zdmc+');
            background-size: contain;
            z-index: 1000;
            transform: translate(-12px, -12px);
            transition: transform 0.2s ease-out;
        }

        .cost-bubble {
            position: absolute;
            background: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 999;
            transform: translate(-50%, -30px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .floating {
            animation: floating 6s ease-in-out infinite;
        }

        @keyframes floating {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        .glow {
            filter: drop-shadow(0 0 8px rgba(16, 185, 129, 0.6));
        }

        .particle {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            z-index: -1;
        }

        .glow-text {
            text-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
        }

        .gradient-text {
            background: linear-gradient(90deg, #10b981, #3b82f6);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .route-line {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: dash 5s linear forwards;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: 0;
            }
        }

        .fade-in {
            animation: fadeIn 1s ease-in forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .rotate-3d {
            animation: rotate3d 15s infinite linear;
        }

        @keyframes rotate3d {
            0% {
                transform: rotateY(0deg);
            }

            100% {
                transform: rotateY(360deg);
            }
        }

        .pulse-ring {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(16, 185, 129, 0.4);
            animation: pulseRing 2s infinite;
            transform: scale(0.8);
            opacity: 0;
        }

        @keyframes pulseRing {
            0% {
                transform: scale(0.8);
                opacity: 0.8;
            }

            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        .weather-icon {
            filter: drop-shadow(0 0 4px rgba(0, 0, 0, 0.2));
            transition: all 0.3s ease;
        }

        .weather-icon:hover {
            transform: scale(1.2);
        }

        .carbon-emission {
            position: relative;
            overflow: hidden;
        }

        .carbon-emission::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.8) 50%, rgba(255, 255, 255, 0) 100%);
            animation: shine 2s infinite;
        }

        @keyframes shine {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        .scroll-indicator {
            animation: bounce 2s infinite;
        }

        @keyframes bounce {

            0%,
            20%,
            50%,
            80%,
            100% {
                transform: translateY(0);
            }

            40% {
                transform: translateY(-20px);
            }

            60% {
                transform: translateY(-10px);
            }
        }

        .three-d-card {
            transform-style: preserve-3d;
            transition: all 0.5s ease;
        }

        .three-d-card:hover {
            transform: rotateY(10deg) rotateX(5deg) translateY(-5px);
            box-shadow: 20px 20px 40px rgba(0, 0, 0, 0.2);
        }

        .parallax-layer {
            position: absolute;
            will-change: transform;
        }
    </style>
</head>

<body class="relative overflow-x-hidden">
    <!-- Particle Background -->
    <div id="particles" class="fixed inset-0 z-0"></div>

    <!-- Navigation -->
    <nav class="nav-glass fixed w-full z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-6">
            <div class="flex justify-between items-center h-20">
                <!-- Logo -->
                <div class="flex items-center">
                    <a href="/" class="flex items-center">
                        <div class="relative">
                            <div class="pulse-ring"></div>
                            <svg class="h-8 w-8 text-emerald-500 glow" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                            </svg>
                        </div>
                        <span class="ml-2 text-xl font-bold text-gray-800">TraceChain</span>
                    </a>
                </div>

                <!-- Navigation Links -->
                <div class="hidden md:flex items-center space-x-8">
                    <a href="/dashboard"
                        class="text-gray-600 hover:text-emerald-600 font-medium text-sm transition relative group">
                        Dashboard
                        <span
                            class="absolute bottom-0 left-0 w-0 h-0.5 bg-emerald-500 transition-all duration-300 group-hover:w-full"></span>
                    </a>
                    <a href="/register"
                        class="text-gray-600 hover:text-emerald-600 font-medium text-sm transition relative group">
                        Register Batch
                        <span class="absolute bottom-0 left-0 w-full h-0.5 bg-emerald-500"></span>
                    </a>
                    <a href="/visualization"
                        class="text-gray-600 hover:text-emerald-600 font-medium text-sm transition relative group">
                        Map
                        <span
                            class="absolute bottom-0 left-0 w-0 h-0.5 bg-emerald-500 transition-all duration-300 group-hover:w-full"></span>
                    </a>
                    <a href="/feedback"
                        class="text-gray-600 hover:text-emerald-600 font-medium text-sm transition relative group">
                        Feedback
                        <span
                            class="absolute bottom-0 left-0 w-0 h-0.5 bg-emerald-500 transition-all duration-300 group-hover:w-full"></span>
                    </a>
                    <a href="/analytics"
                        class="text-gray-600 hover:text-emerald-600 font-medium text-sm transition relative group">
                        Analytics
                        <span
                            class="absolute bottom-0 left-0 w-0 h-0.5 bg-emerald-500 transition-all duration-300 group-hover:w-full"></span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="pt-24 pb-12 px-6 max-w-7xl mx-auto relative z-10">
        <!-- Hero Section -->
        <div class="text-center mb-16">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-4 glow-text">Supply Chain <span
                    class="gradient-text">Optimization</span></h1>
            <p class="text-xl text-gray-600 max-w-3xl mx-auto">Transform your logistics with AI-powered route
                optimization, real-time tracking, and cost-efficient solutions</p>

            <div class="mt-8 flex justify-center space-x-4">
                <button id="getStartedBtn"
                    class="bg-gradient-to-r from-emerald-500 to-blue-500 text-white font-medium py-3 px-6 rounded-lg hover:from-emerald-600 hover:to-blue-600 transition-all shadow-lg hover:shadow-xl transform hover:scale-105">
                    Get Started
                </button>
                <button
                    class="bg-white text-gray-800 font-medium py-3 px-6 rounded-lg border border-gray-200 hover:border-emerald-500 transition-all shadow hover:shadow-md transform hover:scale-105">
                    Watch Demo
                </button>
            </div>

            <div class="mt-12 scroll-indicator">
                <svg class="w-8 h-8 mx-auto text-emerald-500 animate-bounce" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                </svg>
            </div>
        </div>

        <!-- Registration Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-20">
            <!-- Form Section -->
            <div class="form-card p-8 floating three-d-card">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Register Your Shipment</h2>
                <form id="supplyChainForm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="productId" class="block text-sm font-medium text-gray-700 mb-1">Product
                                ID</label>
                            <input type="text" id="productId" name="productId"
                                class="w-full input-field px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        </div>

                        <div>
                            <label for="productName" class="block text-sm font-medium text-gray-700 mb-1">Product
                                Name</label>
                            <input type="text" id="productName" name="productName"
                                class="w-full input-field px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        </div>

                        <div>
                            <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                            <div class="relative">
                                <input type="number" id="quantity" name="quantity"
                                    class="w-full input-field px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                                <div
                                    class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-400">
                                    units
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="weight" class="block text-sm font-medium text-gray-700 mb-1">Weight (kg)</label>
                            <div class="relative">
                                <input type="number" id="weight" name="weight"
                                    class="w-full input-field px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                                <div
                                    class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-400">
                                    kg
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="humidity" class="block text-sm font-medium text-gray-700 mb-1">Humidity
                                (%)</label>
                            <div class="relative">
                                <input type="number" id="humidity" name="humidity" min="0" max="100"
                                    class="w-full input-field px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                                <div
                                    class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-400">
                                    %
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="packagingType" class="block text-sm font-medium text-gray-700 mb-1">Packaging
                                Type</label>
                            <select id="packagingType" name="packagingType"
                                class="w-full input-field px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                                <option value="standard">Standard</option>
                                <option value="refrigerated">Refrigerated</option>
                                <option value="hazardous">Hazardous Materials</option>
                                <option value="fragile">Fragile</option>
                                <option value="bulk">Bulk</option>
                                <option value="perishable">Perishable</option>
                            </select>
                        </div>

                        <div>
                            <label for="temperature" class="block text-sm font-medium text-gray-700 mb-1">Temperature
                                (°C)</label>
                            <div class="relative">
                                <input type="number" id="temperature" name="temperature"
                                    class="w-full input-field px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                                <div
                                    class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-400">
                                    °C
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="value" class="block text-sm font-medium text-gray-700 mb-1">Product
                                Value</label>
                            <div class="relative">
                                <select id="currency" name="currency"
                                    class="absolute left-0 inset-y-0 pl-3 pr-8 flex items-center border-r border-gray-200 bg-gray-50 rounded-l-lg text-gray-600">
                                    <option value="USD">USD</option>
                                    <option value="EUR">EUR</option>
                                    <option value="GBP">GBP</option>
                                    <option value="JPY">JPY</option>
                                    <option value="INR">INR</option>
                                    <option value="CNY">CNY</option>
                                </select>
                                <input type="number" id="value" name="value"
                                    class="w-full input-field pl-20 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            </div>
                        </div>

                        <div class="md:col-span-2">
                            <label for="sourceLocation" class="block text-sm font-medium text-gray-700 mb-1">Source
                                Location</label>
                            <div class="relative">
                                <input type="text" id="sourceLocation" name="sourceLocation"
                                    class="w-full input-field px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                    placeholder="Enter address or select from map">
                                <button type="button" onclick="openMapModal('source')"
                                    class="absolute inset-y-0 right-0 flex items-center pr-3 text-emerald-500 hover:text-emerald-600">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <div class="md:col-span-2">
                            <label for="destinationLocation"
                                class="block text-sm font-medium text-gray-700 mb-1">Destination Location</label>
                            <div class="relative">
                                <input type="text" id="destinationLocation" name="destinationLocation"
                                    class="w-full input-field px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                    placeholder="Enter address or select from map">
                                <button type="button" onclick="openMapModal('destination')"
                                    class="absolute inset-y-0 right-0 flex items-center pr-3 text-emerald-500 hover:text-emerald-600">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Transport Mode</label>
                            <div class="grid grid-cols-4 gap-2">
                                <button type="button" data-mode="road"
                                    class="transport-mode-btn active bg-emerald-100 text-emerald-700 border-emerald-500">
                                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                                    </svg>
                                    Road
                                </button>
                                <button type="button" data-mode="rail"
                                    class="transport-mode-btn bg-blue-100 text-blue-700 border-blue-500">
                                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 19l-7-7 7-7m5.5 14l-7-7 7-7" />
                                    </svg>
                                    Rail
                                </button>
                                <button type="button" data-mode="sea"
                                    class="transport-mode-btn bg-indigo-100 text-indigo-700 border-indigo-500">
                                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M20 12H4m12 0l4-4m-4 4l4 4" />
                                    </svg>
                                    Sea
                                </button>
                                <button type="button" data-mode="air"
                                    class="transport-mode-btn bg-purple-100 text-purple-700 border-purple-500">
                                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 7l4-4m0 0l4 4m-4-4v18m-6-18h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V5a2 2 0 012-2z" />
                                    </svg>
                                    Air
                                </button>
                            </div>
                            <input type="hidden" id="transportMode" name="transportMode" value="road">
                        </div>
                    </div>

                    <div class="mt-8">
                        <button type="submit"
                            class="w-full bg-gradient-to-r from-emerald-500 to-blue-500 text-white font-medium py-3 px-6 rounded-lg hover:from-emerald-600 hover:to-blue-600 transition-all shadow-lg hover:shadow-xl transform hover:scale-[1.01]">
                            Optimize Supply Chain Route
                        </button>
                    </div>
                </form>
            </div>

            <!-- Map Visualization Section -->
            <div class="map-container h-full min-h-[500px] relative three-d-card">
                <div id="routeMap" class="w-full h-full rounded-lg"></div>
                <div id="routeOptions"
                    class="absolute bottom-4 left-4 right-4 bg-white bg-opacity-90 rounded-lg p-4 shadow-lg hidden">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-gray-800">Optimized Route Options</h3>
                        <div class="flex items-center">
                            <span class="text-xs text-gray-500 mr-2">Currency:</span>
                            <select id="displayCurrency" class="text-xs border border-gray-200 rounded px-2 py-1">
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                <option value="GBP">GBP</option>
                                <option value="JPY">JPY</option>
                                <option value="INR">INR</option>
                                <option value="CNY">CNY</option>
                            </select>
                        </div>
                    </div>
                    <div id="routeList" class="space-y-2 max-h-60 overflow-y-auto pr-2"></div>
                </div>
                <div id="truckAnimation" class="moving-truck hidden"></div>
                <div id="weatherInfo"
                    class="absolute top-4 right-4 bg-white bg-opacity-90 rounded-lg p-3 shadow-md hidden">
                    <div class="flex items-center">
                        <div id="weatherIcon" class="weather-icon mr-2"></div>
                        <div>
                            <div id="weatherTemp" class="font-semibold"></div>
                            <div id="weatherDesc" class="text-xs text-gray-600"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="mt-12 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Optimization Results</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-xl p-6 shadow-md hover:shadow-lg transition">
                    <div class="flex items-center mb-4">
                        <div class="bg-emerald-100 p-3 rounded-full mr-4">
                            <svg class="h-6 w-6 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800">Cost Analysis</h3>
                    </div>
                    <div id="costResults" class="text-gray-600">
                        <!-- Will be populated by JS -->
                    </div>
                    <div class="mt-4">
                        <canvas id="costChart" height="150"></canvas>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-6 shadow-md hover:shadow-lg transition">
                    <div class="flex items-center mb-4">
                        <div class="bg-blue-100 p-3 rounded-full mr-4">
                            <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800">Profit Potential</h3>
                    </div>
                    <div id="profitResults" class="text-gray-600">
                        <!-- Will be populated by JS -->
                    </div>
                    <div class="mt-4">
                        <canvas id="profitChart" height="150"></canvas>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-6 shadow-md hover:shadow-lg transition">
                    <div class="flex items-center mb-4">
                        <div class="bg-purple-100 p-3 rounded-full mr-4">
                            <svg class="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800">Recommended Route</h3>
                    </div>
                    <div id="recommendedRoute" class="text-gray-600">
                        <!-- Will be populated by JS -->
                    </div>
                    <div class="mt-4">
                        <canvas id="emissionChart" height="150"></canvas>
                    </div>
                </div>
            </div>

            <!-- Detailed Analysis -->
            <div class="bg-white rounded-xl p-6 shadow-md mb-8">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Detailed Route Analysis</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-medium text-gray-700 mb-2">Route Segments</h4>
                        <div id="routeSegments" class="space-y-3">
                            <!-- Will be populated by JS -->
                        </div>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-700 mb-2">Risk Assessment</h4>
                        <div class="space-y-3">
                            <div class="flex items-center">
                                <div class="w-2/5 text-sm text-gray-600">Weather Conditions</div>
                                <div class="w-3/5">
                                    <div class="bg-gray-200 rounded-full h-2.5">
                                        <div id="weatherRisk" class="bg-yellow-500 h-2.5 rounded-full"
                                            style="width: 30%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <div class="w-2/5 text-sm text-gray-600">Political Stability</div>
                                <div class="w-3/5">
                                    <div class="bg-gray-200 rounded-full h-2.5">
                                        <div id="politicalRisk" class="bg-green-500 h-2.5 rounded-full"
                                            style="width: 75%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <div class="w-2/5 text-sm text-gray-600">Piracy Risk</div>
                                <div class="w-3/5">
                                    <div class="bg-gray-200 rounded-full h-2.5">
                                        <div id="piracyRisk" class="bg-red-500 h-2.5 rounded-full" style="width: 15%">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <div class="w-2/5 text-sm text-gray-600">Customs Delay</div>
                                <div class="w-3/5">
                                    <div class="bg-gray-200 rounded-full h-2.5">
                                        <div id="customsRisk" class="bg-orange-500 h-2.5 rounded-full"
                                            style="width: 45%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h4 class="font-medium text-gray-700 mt-6 mb-2">Carbon Emission</h4>
                        <div class="carbon-emission bg-gray-100 rounded-lg p-4 text-center">
                            <div class="text-3xl font-bold text-emerald-600" id="carbonEmission">1,250 kg</div>
                            <div class="text-sm text-gray-600">CO2 Equivalent</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historical Data Comparison -->
            <div class="bg-white rounded-xl p-6 shadow-md">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Historical Performance Comparison</h3>
                <canvas id="historicalChart" height="250"></canvas>
            </div>
        </div>

        <!-- Features Section -->
        <div class="mt-20">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-12">Why Choose TraceChain?</h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div
                    class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition transform hover:-translate-y-1">
                    <div class="bg-emerald-100 w-12 h-12 rounded-full flex items-center justify-center mb-4">
                        <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">AI-Powered Optimization</h3>
                    <p class="text-gray-600">Our advanced algorithms analyze thousands of variables to find the most
                        efficient route for your shipments.</p>
                </div>

                <div
                    class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition transform hover:-translate-y-1">
                    <div class="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mb-4">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">Real-Time Tracking</h3>
                    <p class="text-gray-600">Monitor your shipments in real-time with our blockchain-powered tracking
                        system.</p>
                </div>

                <div
                    class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition transform hover:-translate-y-1">
                    <div class="bg-purple-100 w-12 h-12 rounded-full flex items-center justify-center mb-4">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">Cost Efficiency</h3>
                    <p class="text-gray-600">Reduce logistics costs by up to 30% with our optimized routing and resource
                        allocation.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Map Selection Modal -->
    <div id="mapModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl w-full max-w-4xl h-[80vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-semibold" id="mapModalTitle">Select Location</h3>
                <button onclick="closeMapModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="flex-1 relative">
                <div id="selectionMap" class="w-full h-full"></div>
                <div class="absolute top-4 left-4 right-4 bg-white bg-opacity-90 rounded-lg p-3 shadow-md z-10">
                    <div class="flex">
                        <input type="text" id="mapSearch"
                            class="flex-1 input-field px-4 py-2 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-emerald-500"
                            placeholder="Search for location...">
                        <button onclick="searchLocation()"
                            class="bg-emerald-500 text-white px-4 py-2 rounded-r-lg hover:bg-emerald-600 transition">
                            Search
                        </button>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t flex justify-end">
                <button onclick="confirmLocationSelection()"
                    class="bg-emerald-500 text-white px-6 py-2 rounded-lg hover:bg-emerald-600 transition">
                    Confirm Selection
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-12 mt-20">
        <div class="max-w-7xl mx-auto px-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <h3 class="text-lg font-semibold mb-4">TraceChain</h3>
                    <p class="text-gray-400">Revolutionizing supply chain management with blockchain technology and AI
                        optimization.</p>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-4">Quick Links</h3>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Home</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Features</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Pricing</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Contact</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-4">Resources</h3>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Documentation</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">API</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Blog</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Support</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-4">Connect</h3>
                    <div class="flex space-x-4">
                        <a href="#" class="text-gray-400 hover:text-white transition">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z" />
                            </svg>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-white transition">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z" />
                            </svg>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-white transition">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z" />
                            </svg>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-white transition">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M22.675 0h-21.35c-.732 0-1.325.593-1.325 1.325v21.351c0 .731.593 1.324 1.325 1.324h11.495v-9.294h-3.128v-3.622h3.128v-2.671c0-3.1 1.893-4.788 4.659-4.788 1.325 0 2.463.099 2.795.143v3.24l-1.918.001c-1.504 0-1.795.715-1.795 1.763v2.313h3.587l-.467 3.622h-3.12v9.293h6.116c.73 0 1.323-.593 1.323-1.325v-21.35c0-.732-.593-1.325-1.325-1.325z" />
                            </svg>
                        </a>
                    </div>
                    <div class="mt-4">
                        <p class="text-gray-400">Subscribe to our newsletter</p>
                        <div class="flex mt-2">
                            <input type="email" placeholder="Your email"
                                class="px-3 py-2 bg-gray-800 text-white rounded-l focus:outline-none w-full">
                            <button
                                class="bg-emerald-500 text-white px-4 py-2 rounded-r hover:bg-emerald-600 transition">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M14 5l7 7m0 0l-7 7m7-7H3" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-800 mt-8 pt-8 text-center text-gray-400">
                <p>&copy; 2023 TraceChain. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Create particle background
            createParticles();

            // Initialize main map
            const map = L.map('routeMap').setView([20, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 18,
            }).addTo(map);

            // Initialize selection map (for modal)
            let selectionMap;
            let currentMapSelectionType = '';
            let selectedLocation = null;
            let selectedLocationMarker = null;

            // Initialize geocoder
            const geocoder = new GeoSearch.GeoSearchControl({
                provider: new GeoSearch.OpenStreetMapProvider(),
                style: 'bar',
                searchLabel: 'Search location',
                notFoundMessage: 'Location not found',
            });

            // Transport mode buttons
            document.querySelectorAll('.transport-mode-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    document.querySelectorAll('.transport-mode-btn').forEach(b => {
                        b.classList.remove('active', 'border-2');
                        b.classList.add('border');
                    });

                    this.classList.add('active', 'border-2');
                    this.classList.remove('border');
                    document.getElementById('transportMode').value = this.dataset.mode;
                });
            });

            // Currency conversion rates (simplified - in a real app, you'd fetch these from an API)
            const exchangeRates = {
                USD: { EUR: 0.85, GBP: 0.73, JPY: 110.25, INR: 74.50, CNY: 6.45 },
                EUR: { USD: 1.18, GBP: 0.86, JPY: 129.75, INR: 87.65, CNY: 7.60 },
                GBP: { USD: 1.37, EUR: 1.16, JPY: 151.20, INR: 102.10, CNY: 8.85 },
                JPY: { USD: 0.0091, EUR: 0.0077, GBP: 0.0066, INR: 0.68, CNY: 0.059 },
                INR: { USD: 0.013, EUR: 0.011, GBP: 0.0098, JPY: 1.47, CNY: 0.087 },
                CNY: { USD: 0.16, EUR: 0.13, GBP: 0.11, JPY: 16.95, INR: 11.50 }
            };

            // Improved geocoding function with caching
            const geocodeCache = {};
            async function geocodeAddress(address) {
                if (!address) return null;
                
                // Check cache first
                if (geocodeCache[address.toLowerCase()]) {
                    return geocodeCache[address.toLowerCase()];
                }

                // Check if it's one of our predefined cities
                const cityKey = address.toLowerCase().replace(/[^a-z]/g, '_');
                if (cities[cityKey]) {
                    geocodeCache[address.toLowerCase()] = {
                        lat: cities[cityKey].lat,
                        lng: cities[cityKey].lng,
                        name: cities[cityKey].name
                    };
                    return geocodeCache[address.toLowerCase()];
                }

                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
                    const data = await response.json();
                    if (data.length > 0) {
                        const result = {
                            lat: parseFloat(data[0].lat),
                            lng: parseFloat(data[0].lon),
                            name: data[0].display_name
                        };
                        geocodeCache[address.toLowerCase()] = result;
                        return result;
                    }
                    return null;
                } catch (error) {
                    console.error("Geocoding error:", error);
                    return null;
                }
            }

            // Function to convert currency
            function convertCurrency(amount, fromCurrency, toCurrency) {
                if (fromCurrency === toCurrency) return amount;
                return amount * exchangeRates[fromCurrency][toCurrency];
            }

            // Format currency
            function formatCurrency(amount, currency) {
                const formatter = new Intl.NumberFormat(undefined, {
                    style: 'currency',
                    currency: currency,
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });

                // For currencies that don't have symbols in Intl (like INR, CNY)
                if (currency === 'INR') return '₹' + amount.toFixed(2);
                if (currency === 'CNY') return '¥' + amount.toFixed(2);
                if (currency === 'JPY') return '¥' + amount.toFixed(0);

                return formatter.format(amount);
            }

            // Update all displayed currencies when user changes display currency
            document.getElementById('displayCurrency').addEventListener('change', function () {
                updateDisplayedCurrencies();
            });

            function updateDisplayedCurrencies() {
                const displayCurrency = document.getElementById('displayCurrency').value;

                // Update route options
                document.querySelectorAll('.route-cost').forEach(el => {
                    const originalAmount = parseFloat(el.dataset.originalAmount);
                    const originalCurrency = el.dataset.originalCurrency;
                    const convertedAmount = convertCurrency(originalAmount, originalCurrency, displayCurrency);
                    el.textContent = formatCurrency(convertedAmount, displayCurrency);
                });

                // Update results section
                if (document.getElementById('resultsSection').classList.contains('hidden')) return;

                // Cost results
                const optimalCost = parseFloat(document.getElementById('optimalCost').dataset.originalAmount);
                const optimalCurrency = document.getElementById('optimalCost').dataset.originalCurrency;
                document.getElementById('optimalCost').textContent = formatCurrency(
                    convertCurrency(optimalCost, optimalCurrency, displayCurrency),
                    displayCurrency
                );

                const avgCost = parseFloat(document.getElementById('avgCost').dataset.originalAmount);
                const avgCurrency = document.getElementById('avgCost').dataset.originalCurrency;
                document.getElementById('avgCost').textContent = formatCurrency(
                    convertCurrency(avgCost, avgCurrency, displayCurrency),
                    displayCurrency
                );

                const savings = parseFloat(document.getElementById('savings').dataset.originalAmount);
                const savingsCurrency = document.getElementById('savings').dataset.originalCurrency;
                document.getElementById('savings').textContent = formatCurrency(
                    convertCurrency(savings, savingsCurrency, displayCurrency),
                    displayCurrency
                );

                // Profit results
                const estimatedProfit = parseFloat(document.getElementById('estimatedProfit').dataset.originalAmount);
                const profitCurrency = document.getElementById('estimatedProfit').dataset.originalCurrency;
                document.getElementById('estimatedProfit').textContent = formatCurrency(
                    convertCurrency(estimatedProfit, profitCurrency, displayCurrency),
                    displayCurrency
                );

                // Update charts
                updateChartsWithNewCurrency(displayCurrency);
            }

            // Form submission
            const form = document.getElementById('supplyChainForm');
            const routeOptions = document.getElementById('routeOptions');
            const routeList = document.getElementById('routeList');
            const resultsSection = document.getElementById('resultsSection');
            const costResults = document.getElementById('costResults');
            const profitResults = document.getElementById('profitResults');
            const recommendedRoute = document.getElementById('recommendedRoute');
            const truckAnimation = document.getElementById('truckAnimation');
            const weatherInfo = document.getElementById('weatherInfo');

            let currentRoutes = [];
            let currentCharts = {};

            form.addEventListener('submit', async function (e) {
                e.preventDefault();

                // Get form values
                const sourceAddress = document.getElementById('sourceLocation').value;
                const destinationAddress = document.getElementById('destinationLocation').value;
                const quantity = parseInt(document.getElementById('quantity').value) || 1;
                const weight = parseInt(document.getElementById('weight').value) || 1;
                const packagingType = document.getElementById('packagingType').value;
                const temperature = parseInt(document.getElementById('temperature').value) || 20;
                const transportMode = document.getElementById('transportMode').value;
                const currency = document.getElementById('currency').value;
                const productValue = parseFloat(document.getElementById('value').value) || 0;

                try {
                    // Geocode both addresses
                    const [sourceResult, destResult] = await Promise.all([
                        geocodeAddress(sourceAddress),
                        geocodeAddress(destinationAddress)
                    ]);

                    if (!sourceResult || !destResult) {
                        alert("Could not find one or both locations. Please try more specific addresses.");
                        return;
                    }

                    const sourceCoords = [sourceResult.lat, sourceResult.lng];
                    const destCoords = [destResult.lat, destResult.lng];

                    // Clear previous map elements
                    map.eachLayer(layer => {
                        if (layer instanceof L.Polyline || layer instanceof L.Marker) {
                            map.removeLayer(layer);
                        }
                    });

                    // Add source and destination markers with actual addresses
                    L.marker(sourceCoords).addTo(map)
                        .bindPopup(`<b>Source:</b> ${sourceResult.name}`)
                        .openPopup();

                    L.marker(destCoords).addTo(map)
                        .bindPopup(`<b>Destination:</b> ${destResult.name}`);

                    // Calculate actual distance between points (great circle distance)
                    const distance = calculateDistance(sourceCoords, destCoords);
                    
                    // Generate routes based on transport mode and actual distance
                    const routes = generateRoutesBasedOnMode(sourceCoords, destCoords, distance, transportMode);

                    // Adjust costs based on form inputs
                    routes.forEach(route => {
                        // Base cost adjustments
                        if (packagingType === 'refrigerated') {
                            route.cost *= 1.3;
                        } else if (packagingType === 'hazardous') {
                            route.cost *= 1.5;
                        } else if (packagingType === 'fragile') {
                            route.cost *= 1.2;
                        } else if (packagingType === 'perishable') {
                            route.cost *= 1.4;
                        } else if (packagingType === 'bulk') {
                            route.cost *= 0.9;
                        }

                        // Temperature adjustments
                        if (temperature < 0 || temperature > 30) {
                            route.cost *= 1.25;
                        }

                        // Transport mode adjustments
                        if (transportMode === 'air') {
                            route.cost *= 2.5;
                            route.time *= 0.3;
                            route.emissions *= 3;
                        } else if (transportMode === 'sea') {
                            route.cost *= 0.7;
                            route.time *= 1.5;
                            route.emissions *= 0.8;
                        } else if (transportMode === 'rail') {
                            route.cost *= 0.9;
                            route.time *= 1.1;
                            route.emissions *= 0.7;
                        }

                        // Weight adjustments
                        route.cost = route.cost * Math.sqrt(weight); // Non-linear scaling for weight

                        // Quantity adjustments
                        route.cost = route.cost * Math.sqrt(quantity); // Economies of scale

                        // Calculate profit (realistic calculation)
                        const baseRevenue = productValue * quantity;
                        const revenue = baseRevenue * 0.8; // Assume 80% of product value is revenue
                        route.profit = revenue - route.cost;

                        // Add currency information
                        route.currency = currency;
                    });

                    // Sort routes by cost (ascending)
                    routes.sort((a, b) => a.cost - b.cost);

                    // Store current routes for currency conversion
                    currentRoutes = routes;

                    // Display routes on map
                    routeList.innerHTML = '';
                    routes.forEach((route, index) => {
                        // Draw route on map
                        const polyline = L.polyline(route.path, {
                            color: index === 0 ? '#ef4444' : '#3b82f6', // Red for optimal, blue for others
                            weight: index === 0 ? 4 : 2,
                            opacity: 0.8
                        }).addTo(map);

                        // Add cost bubbles at midpoints
                        route.path.forEach((point, i) => {
                            if (i > 0 && i < route.path.length - 1) {
                                const midLat = (route.path[i][0] + route.path[i - 1][0]) / 2;
                                const midLng = (route.path[i][1] + route.path[i - 1][1]) / 2;

                                const bubble = L.marker([midLat, midLng], {
                                    icon: L.divIcon({
                                        className: 'cost-bubble',
                                        html: `${formatCurrency(route.cost / route.path.length, route.currency)}`,
                                        iconSize: [60, 20]
                                    })
                                }).addTo(map);

                                // Animate bubble appearance
                                setTimeout(() => {
                                    bubble.getElement().style.opacity = '1';
                                }, i * 300);
                            }
                        });

                        // Add to route options list
                        const routeEl = document.createElement('div');
                        routeEl.className = `route-option p-3 rounded-lg cursor-pointer ${index === 0 ? 'optimal-route border-2 border-emerald-500' : 'border border-gray-200'}`;
                        routeEl.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4 class="font-medium">Route Option ${index + 1}</h4>
                                    <div class="text-sm text-gray-600">${route.distance.toFixed(0)} km • ${route.time} days • ${route.emissions.toFixed(0)} kg CO2</div>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold route-cost" data-original-amount="${route.cost}" data-original-currency="${route.currency}">
                                        ${formatCurrency(route.cost, route.currency)}
                                    </div>
                                    <div class="text-xs ${index === 0 ? 'text-emerald-600' : 'text-gray-500'}">${index === 0 ? 'OPTIMAL' : 'ALTERNATIVE'}</div>
                                </div>
                            </div>
                        `;

                        routeEl.addEventListener('click', () => {
                            animateTruckAlongRoute(route.path);
                        });

                        routeList.appendChild(routeEl);
                    });

                    // Show route options
                    routeOptions.classList.remove('hidden');

                    // Fit map to show all routes
                    const bounds = new L.LatLngBounds(
                        routes.flatMap(route => route.path).concat([sourceCoords, destCoords])
                    );
                    map.fitBounds(bounds, { padding: [50, 50] });

                    // Show weather for destination
                    fetchWeather(destCoords[0], destCoords[1]);
                    weatherInfo.classList.remove('hidden');

                    // Show results
                    displayResults(routes);
                    resultsSection.classList.remove('hidden');

                    // Animate the optimal route by default
                    animateTruckAlongRoute(routes[0].path);

                    // Create charts
                    createCharts(routes);
                } catch (error) {
                    console.error("Error processing route:", error);
                    alert("An error occurred while processing your route. Please try again.");
                }
            });

            // Calculate distance between two coordinates in km (Haversine formula)
            function calculateDistance(coord1, coord2) {
                const [lat1, lon1] = coord1;
                const [lat2, lon2] = coord2;
                
                const R = 6371; // Radius of the Earth in km
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = 
                    Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                    Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }

            function generateRoutesBasedOnMode(sourceCoords, destCoords, distance, transportMode) {
                const routes = [];
                
                // Base cost per km for each transport mode
                const baseCostPerKm = {
                    road: 0.5,
                    rail: 0.3,
                    sea: 0.2,
                    air: 1.5
                };
                
                // Base time per km (hours) for each transport mode
                const baseTimePerKm = {
                    road: 0.1,
                    rail: 0.05,
                    sea: 0.03,
                    air: 0.01
                };
                
                // Base emissions per km (kg CO2) for each transport mode
                const baseEmissionsPerKm = {
                    road: 0.2,
                    rail: 0.1,
                    sea: 0.15,
                    air: 0.5
                };
                
                // Generate 3 route options
                for (let i = 0; i < 3; i++) {
                    const path = [];
                    path.push(sourceCoords);
                    
                    // Add intermediate points based on transport mode (keep existing path generation)
                    if (transportMode === 'road' || transportMode === 'rail') {
                        if (i === 0) {
                            path.push(destCoords);
                        } else {
                            const numPoints = i;
                            for (let j = 1; j <= numPoints; j++) {
                                const lat = sourceCoords[0] + (destCoords[0] - sourceCoords[0]) * (j / (numPoints + 1));
                                const lng = sourceCoords[1] + (destCoords[1] - sourceCoords[1]) * (j / (numPoints + 1));
                                path.push([lat, lng]);
                            }
                            path.push(destCoords);
                        }
                    } else if (transportMode === 'sea') {
                        if (i === 0) {
                            path.push(destCoords);
                        } else {
                            const midLat = (sourceCoords[0] + destCoords[0]) / 2;
                            const midLng = (sourceCoords[1] + destCoords[1]) / 2;
                            
                            if (i === 1) {
                                path.push([midLat, midLng]);
                            } else {
                                path.push([
                                    (sourceCoords[0] + midLat) / 2,
                                    (sourceCoords[1] + midLng) / 2
                                ]);
                                path.push([
                                    (midLat + destCoords[0]) / 2,
                                    (midLng + destCoords[1]) / 2
                                ]);
                            }
                            path.push(destCoords);
                        }
                    } else if (transportMode === 'air') {
                        if (i < 2) {
                            path.push(destCoords);
                        } else {
                            const midLat = (sourceCoords[0] + destCoords[0]) / 2;
                            const midLng = (sourceCoords[1] + destCoords[1]) / 2;
                            path.push([midLat, midLng]);
                            path.push(destCoords);
                        }
                    }
                    
                    // Calculate route distance (sum of segments)
                    let routeDistance = 0;
                    for (let k = 1; k < path.length; k++) {
                        routeDistance += calculateDistance(path[k-1], path[k]);
                    }
                    
                    // Calculate base values with variability
                    const baseCost = routeDistance * baseCostPerKm[transportMode];
                    const cost = baseCost * (0.9 + Math.random() * 0.2);
                    const time = (routeDistance * baseTimePerKm[transportMode] / 24) * (0.8 + Math.random() * 0.4);
                    const emissions = (routeDistance * baseEmissionsPerKm[transportMode]) * (0.9 + Math.random() * 0.2);
                    
                    // New balanced profit calculation
                    const minMargin = -0.2;  // -20% minimum
                    const maxMargin = 0.4;   // +40% maximum
                    
                    // Mode-specific margin adjustments
                    const modeMarginFactors = {
                        road: 0.9,   // Slightly lower margins for road
                        rail: 1.1,   // Better margins for rail
                        sea: 1.0,    // Standard for sea
                        air: 1.15    // Premium margins for air
                    };
                    
                    // Calculate base profit margin with randomness
                    const baseMargin = minMargin + (Math.random() * (maxMargin - minMargin));
                    const adjustedMargin = baseMargin * modeMarginFactors[transportMode];
                    
                    // Calculate final profit with reasonable bounds
                    const profit = cost * Math.max(minMargin, Math.min(maxMargin, adjustedMargin));
                    
                    // Ensure profit isn't exactly zero (more realistic)
                    const finalProfit = Math.abs(profit) < cost * 0.01 
                        ? cost * 0.05  // Default to small 5% profit if near zero
                        : profit;
                    
                    routes.push({
                        path: path,
                        distance: routeDistance,
                        cost: cost,
                        time: time,
                        emissions: emissions,
                        profit: finalProfit,
                        currency: 'USD'
                    });
                }
                
                return routes;
            }

            function animateTruckAlongRoute(path) {
                truckAnimation.classList.remove('hidden');

                // Convert path to LatLng objects
                const latLngs = path.map(point => L.latLng(point[0], point[1]));

                // Create a polyline to calculate points along the route
                const polyline = L.polyline(latLngs);
                const routeLength = polyline.getLatLngs().reduce((total, latLng, i, arr) => {
                    if (i === 0) return total;
                    return total + latLng.distanceTo(arr[i - 1]);
                }, 0);

                // Animation parameters
                const duration = 10000; // ms
                const startTime = Date.now();
                const endTime = startTime + duration;

                // Clear any existing animation
                if (window.truckAnimation) {
                    cancelAnimationFrame(window.truckAnimation);
                }

                // Add pulsing circles along the route
                path.forEach((point, index) => {
                    if (index > 0 && index < path.length - 1) {
                        const marker = L.circleMarker(point, {
                            radius: 5,
                            color: '#10b981',
                            fillColor: '#10b981',
                            fillOpacity: 0.8
                        }).addTo(map);

                        // Animate the circle
                        let scale = 1;
                        const animateCircle = () => {
                            scale += 0.05;
                            marker.setRadius(5 * scale);
                            marker.setStyle({ opacity: 1 / scale });

                            if (scale < 3) {
                                requestAnimationFrame(animateCircle);
                            } else {
                                map.removeLayer(marker);
                            }
                        };

                        setTimeout(() => {
                            animateCircle();
                        }, index * (duration / path.length));
                    }
                });

                function animate() {
                    const now = Date.now();
                    const progress = Math.min(1, (now - startTime) / duration);

                    if (progress >= 1) {
                        // Animation complete
                        truckAnimation.classList.add('hidden');
                        return;
                    }

                    // Calculate current position along the route
                    const targetDistance = routeLength * progress;
                    let accumulatedDistance = 0;
                    let currentLatLng = latLngs[0];

                    for (let i = 1; i < latLngs.length; i++) {
                        const segmentDistance = latLngs[i].distanceTo(latLngs[i - 1]);

                        if (accumulatedDistance + segmentDistance >= targetDistance) {
                            // We're on this segment
                            const segmentProgress = (targetDistance - accumulatedDistance) / segmentDistance;
                            currentLatLng = L.latLng(
                                latLngs[i - 1].lat + (latLngs[i].lat - latLngs[i - 1].lat) * segmentProgress,
                                latLngs[i - 1].lng + (latLngs[i].lng - latLngs[i - 1].lng) * segmentProgress
                            );
                            break;
                        }

                        accumulatedDistance += segmentDistance;
                    }

                    // Convert LatLng to pixel coordinates
                    const point = map.latLngToLayerPoint(currentLatLng);

                    // Position the truck
                    truckAnimation.style.left = `${point.x}px`;
                    truckAnimation.style.top = `${point.y}px`;

                    // Rotate truck based on direction
                    if (window.lastTruckPoint) {
                        const angle = Math.atan2(point.y - window.lastTruckPoint.y, point.x - window.lastTruckPoint.x) * 180 / Math.PI;
                        truckAnimation.style.transform = `translate(-12px, -12px) rotate(${angle}deg)`;
                    }
                    window.lastTruckPoint = point;

                    // Continue animation
                    window.truckAnimation = requestAnimationFrame(animate);
                }

                // Start animation
                animate();
            }

            function displayResults(routes) {
                const optimalRoute = routes[0];
                const displayCurrency = document.getElementById('displayCurrency').value;

                // Cost Analysis
                const avgCost = routes.reduce((sum, route) => sum + route.cost, 0) / routes.length;
                const savings = routes[1].cost - optimalRoute.cost;

                costResults.innerHTML = `
                    <div class="mb-2">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-600">Optimal Route Cost:</span>
                            <span id="optimalCost" class="font-semibold" data-original-amount="${optimalRoute.cost}" data-original-currency="${optimalRoute.currency}">
                                ${formatCurrency(optimalRoute.cost, optimalRoute.currency)}
                            </span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-emerald-500 h-2 rounded-full" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-600">Average Alternative:</span>
                            <span id="avgCost" class="font-semibold" data-original-amount="${avgCost}" data-original-currency="${optimalRoute.currency}">
                                ${formatCurrency(avgCost, optimalRoute.currency)}
                            </span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full" style="width: ${(optimalRoute.cost / avgCost * 100).toFixed(0)}%"></div>
                        </div>
                    </div>
                    <div class="text-sm text-gray-600 mt-4">
                        <span class="font-medium text-emerald-600">Savings:</span> 
                        <span id="savings" data-original-amount="${savings}" data-original-currency="${optimalRoute.currency}">
                            ${formatCurrency(savings, optimalRoute.currency)}
                        </span> vs next best option
                    </div>
                `;

                const profitMargin = (optimalRoute.profit / optimalRoute.cost) * 100;

                // Profit Potential
                profitResults.innerHTML = `
                    <div class="mb-2">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-600">Estimated Profit:</span>
                            <span id="estimatedProfit" class="font-semibold ${optimalRoute.profit >= 0 ? 'text-emerald-600' : 'text-red-600'}" 
                                data-original-amount="${optimalRoute.profit}" data-original-currency="${optimalRoute.currency}">
                                ${optimalRoute.profit >= 0 ? '+' : ''}${formatCurrency(optimalRoute.profit, optimalRoute.currency)}
                            </span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="${optimalRoute.profit >= 0 ? 'bg-emerald-500' : 'bg-red-500'} h-2 rounded-full" 
                                style="width: ${Math.min(100, Math.abs(profitMargin))}%">
                            </div>
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-600">Profit Margin:</span>
                            <span class="font-semibold ${profitMargin >= 0 ? 'text-emerald-600' : 'text-red-600'}">
                                ${profitMargin >= 0 ? '+' : ''}${profitMargin.toFixed(1)}%
                            </span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="${profitMargin >= 0 ? 'bg-emerald-500' : 'bg-red-500'} h-2 rounded-full" 
                                style="width: ${Math.min(100, Math.abs(profitMargin))}%">
                            </div>
                        </div>
                    </div>
                    <div class="text-sm ${optimalRoute.profit >= 0 ? 'text-emerald-600' : 'text-red-600'} mt-4">
                        <span class="font-medium">Potential:</span> 
                        ${optimalRoute.profit >= optimalRoute.cost * 0.3 ? 'High' : 
                        optimalRoute.profit >= 0 ? 'Medium' : 'Low'} profit opportunity
                    </div>
                    <div class="flex items-center mt-3">
                        <div class="mr-4">
                            <input type="checkbox" ${optimalRoute.profit >= 0 ? 'checked' : ''} class="mr-1" disabled>
                            <span>Profit</span>
                        </div>
                        <div>
                            <input type="checkbox" checked class="mr-1" disabled>
                            <span>Cost</span>
                        </div>
                    </div>
                `;

                // Recommended Route
                recommendedRoute.innerHTML = `
                    <div class="flex items-center mb-2">
                        <svg class="h-4 w-4 text-emerald-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        <span>Distance: ${optimalRoute.distance.toFixed(0)} km</span>
                    </div>
                    <div class="flex items-center mb-2">
                        <svg class="h-4 w-4 text-emerald-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        <span>Transit Time: ${optimalRoute.time.toFixed(1)} days</span>
                    </div>
                    <div class="flex items-center mb-2">
                        <svg class="h-4 w-4 text-emerald-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        <span>Emissions: ${optimalRoute.emissions.toFixed(0)} kg CO2</span>
                    </div>
                    <div class="mt-4 text-sm bg-emerald-50 p-2 rounded-lg">
                        This route was selected for optimal cost efficiency while meeting all delivery requirements.
                    </div>
                `;

                // Route Segments
                const routeSegments = document.getElementById('routeSegments');
                routeSegments.innerHTML = '';

                for (let i = 1; i < optimalRoute.path.length; i++) {
                    const start = optimalRoute.path[i - 1];
                    const end = optimalRoute.path[i];

                    // Calculate distance between points
                    const distance = calculateDistance(start, end);

                    const segmentEl = document.createElement('div');
                    segmentEl.className = 'flex items-center justify-between p-2 bg-gray-50 rounded-lg';
                    segmentEl.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-8 h-8 rounded-full bg-emerald-100 flex items-center justify-center mr-3">
                                <svg class="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </div>
                            <div>
                                <div class="text-sm font-medium">Segment ${i}</div>
                                <div class="text-xs text-gray-500">${distance.toFixed(0)} km</div>
                            </div>
                        </div>
                        <div class="text-sm text-emerald-600">${(optimalRoute.time / (optimalRoute.path.length - 1)).toFixed(1)} days</div>
                    `;

                    routeSegments.appendChild(segmentEl);
                }

                // Carbon emission
                document.getElementById('carbonEmission').textContent = `${optimalRoute.emissions.toFixed(0).toLocaleString()} kg`;
            }

            function createCharts(routes) {
                // Destroy existing charts if they exist
                if (currentCharts.costChart) currentCharts.costChart.destroy();
                if (currentCharts.profitChart) currentCharts.profitChart.destroy();
                if (currentCharts.emissionChart) currentCharts.emissionChart.destroy();
                if (currentCharts.historicalChart) currentCharts.historicalChart.destroy();

                const currency = document.getElementById('displayCurrency').value;
                const optimalRoute = routes[0];

                // Cost Chart
                const costCtx = document.getElementById('costChart').getContext('2d');
                currentCharts.costChart = new Chart(costCtx, {
                    type: 'bar',
                    data: {
                        labels: routes.map((_, i) => `Option ${i + 1}`),
                        datasets: [{
                            label: 'Cost',
                            data: routes.map(r => convertCurrency(r.cost, r.currency, currency)),
                            backgroundColor: [
                                'rgba(16, 185, 129, 0.7)',
                                'rgba(59, 130, 246, 0.5)',
                                'rgba(59, 130, 246, 0.5)'
                            ],
                            borderColor: [
                                'rgba(16, 185, 129, 1)',
                                'rgba(59, 130, 246, 1)',
                                'rgba(59, 130, 246, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return `${currency} ${context.raw.toFixed(2)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function (value) {
                                        return `${currency} ${value}`;
                                    }
                                }
                            }
                        }
                    }
                });

                // Replace the profit chart with this version
                const profitCtx = document.getElementById('profitChart').getContext('2d');
                currentCharts.profitChart = new Chart(profitCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Profit', 'Cost'],
                        datasets: [{
                            data: [
                                Math.max(0, optimalRoute.profit),  // Only show positive profit
                                Math.max(0, optimalRoute.cost)     // Always show cost
                            ],
                            backgroundColor: [
                                optimalRoute.profit >= 0 ? 'rgba(16, 185, 129, 0.7)' : 'rgba(239, 68, 68, 0)',
                                'rgba(156, 163, 175, 0.7)'
                            ],
                            borderColor: [
                                optimalRoute.profit >= 0 ? 'rgba(16, 185, 129, 1)' : 'rgba(239, 68, 68, 0)',
                                'rgba(156, 163, 175, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        cutout: '70%',
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw;
                                        return `${label}: ${formatCurrency(value, optimalRoute.currency)}`;
                                    }
                                }
                            },
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
            });

                // Emission Chart
                const emissionCtx = document.getElementById('emissionChart').getContext('2d');
                currentCharts.emissionChart = new Chart(emissionCtx, {
                    type: 'line',
                    data: {
                        labels: routes.map((_, i) => `Option ${i + 1}`),
                        datasets: [{
                            label: 'Carbon Emissions (kg)',
                            data: routes.map(r => r.emissions),
                            backgroundColor: 'rgba(139, 92, 246, 0.2)',
                            borderColor: 'rgba(139, 92, 246, 1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                // Historical Chart
                const historicalCtx = document.getElementById('historicalChart').getContext('2d');
                currentCharts.historicalChart = new Chart(historicalCtx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                        datasets: [
                            {
                                label: 'Average Cost',
                                data: [8500, 8200, 8800, 7900, 8300, 8100, 8000, 7800, 7700, 7600, 7500, 7400],
                                borderColor: 'rgba(16, 185, 129, 1)',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Average Emissions',
                                data: [1200, 1250, 1300, 1150, 1100, 1050, 1000, 950, 900, 850, 800, 750],
                                borderColor: 'rgba(139, 92, 246, 1)',
                                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.datasetIndex === 0) {
                                            label += `${currency} ${convertCurrency(context.raw, 'USD', currency).toFixed(2)}`;
                                        } else {
                                            label += `${context.raw} kg`;
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Cost'
                                },
                                ticks: {
                                    callback: function (value) {
                                        return `${currency} ${value}`;
                                    }
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Emissions (kg)'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                },
                            }
                        }
                    }
                });
            }

            function updateChartsWithNewCurrency(currency) {
                if (!currentCharts.costChart || !currentRoutes.length) return;

                // Update Cost Chart
                currentCharts.costChart.data.datasets[0].data = currentRoutes.map(r =>
                    convertCurrency(r.cost, r.currency, currency)
                );
                currentCharts.costChart.options.scales.y.ticks.callback = function (value) {
                    return `${currency} ${value}`;
                };
                currentCharts.costChart.update();

                // Update Profit Chart
                const optimalRoute = currentRoutes[0];
                currentCharts.profitChart.data.datasets[0].data = [
                    convertCurrency(Math.max(0, optimalRoute.profit), optimalRoute.currency, currency),
                    convertCurrency(optimalRoute.cost, optimalRoute.currency, currency)
                ];
                currentCharts.profitChart.update();

                // Update Historical Chart
                currentCharts.historicalChart.options.scales.y.ticks.callback = function (value) {
                    return `${currency} ${value}`;
                };
                currentCharts.historicalChart.update();
            }

            // Map modal functions
            function openMapModal(type) {
                currentMapSelectionType = type;
                document.getElementById('mapModal').classList.remove('hidden');
                document.getElementById('mapModalTitle').textContent = `Select ${type === 'source' ? 'Source' : 'Destination'} Location`;

                // Initialize map if not already done
                if (!selectionMap) {
                    selectionMap = L.map('selectionMap').setView([20, 0], 2);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                        maxZoom: 18,
                    }).addTo(selectionMap);

                    // Add geocoder
                    selectionMap.addControl(geocoder);

                    // Add click handler
                    selectionMap.on('click', function (e) {
                        if (selectedLocationMarker) {
                            selectionMap.removeLayer(selectedLocationMarker);
                        }

                        selectedLocation = e.latlng;
                        selectedLocationMarker = L.marker(e.latlng, {
                            icon: L.divIcon({
                                className: 'text-emerald-500 text-2xl',
                                html: `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>`,
                                iconSize: [32, 32],
                                iconAnchor: [16, 32]
                            })
                        }).addTo(selectionMap);

                        // Reverse geocode to get address
                        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e.latlng.lat}&lon=${e.latlng.lng}`)
                            .then(response => response.json())
                            .then(data => {
                                document.getElementById('mapSearch').value = data.display_name || `${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
                            });
                    });
                }
            }

            function closeMapModal() {
                document.getElementById('mapModal').classList.add('hidden');
            }

            function searchLocation() {
                const query = document.getElementById('mapSearch').value;
                if (!query) return;

                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length > 0) {
                            const result = data[0];
                            const latlng = L.latLng(parseFloat(result.lat), parseFloat(result.lon));

                            if (selectedLocationMarker) {
                                selectionMap.removeLayer(selectedLocationMarker);
                            }

                            selectedLocation = latlng;
                            selectedLocationMarker = L.marker(latlng, {
                                icon: L.divIcon({
                                    className: 'text-emerald-500 text-2xl',
                                    html: `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>`,
                                    iconSize: [32, 32],
                                    iconAnchor: [16, 32]
                                })
                            }).addTo(selectionMap);

                            selectionMap.setView(latlng, 12);
                        }
                    });
            }

            function confirmLocationSelection() {
                if (!selectedLocation) return;

                // Reverse geocode to get address
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${selectedLocation.lat}&lon=${selectedLocation.lng}`)
                    .then(response => response.json())
                    .then(data => {
                        const address = data.display_name || `${selectedLocation.lat.toFixed(4)}, ${selectedLocation.lng.toFixed(4)}`;

                        if (currentMapSelectionType === 'source') {
                            document.getElementById('sourceLocation').value = address;
                        } else {
                            document.getElementById('destinationLocation').value = address;
                        }

                        closeMapModal();
                    });
            }

            // Fetch weather data
            function fetchWeather(lat, lng) {
                // In a real app, you'd call a weather API here
                // For demo purposes, we'll use mock data
                const weatherData = {
                    temp: Math.round(15 + Math.random() * 20),
                    desc: ['Sunny', 'Cloudy', 'Rainy', 'Stormy'][Math.floor(Math.random() * 4)],
                    icon: {
                        Sunny: '☀️',
                        Cloudy: '☁️',
                        Rainy: '🌧️',
                        Stormy: '⛈️'
                    }
                };

                document.getElementById('weatherTemp').textContent = `${weatherData.temp}°C`;
                document.getElementById('weatherDesc').textContent = weatherData.desc;
                document.getElementById('weatherIcon').textContent = weatherData.icon[weatherData.desc];

                // Update risk based on weather
                const weatherRisk = weatherData.desc === 'Stormy' ? 80 :
                    weatherData.desc === 'Rainy' ? 50 :
                        weatherData.desc === 'Cloudy' ? 30 : 10;
                document.getElementById('weatherRisk').style.width = `${weatherRisk}%`;
            }

            // Create particle background
            function createParticles() {
                const container = document.getElementById('particles');
                const particleCount = 30;

                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';

                    // Random properties
                    const size = Math.random() * 5 + 2;
                    const posX = Math.random() * 100;
                    const posY = Math.random() * 100;
                    const delay = Math.random() * 10;
                    const duration = Math.random() * 20 + 10;
                    const color = `rgba(16, 185, 129, ${Math.random() * 0.3 + 0.1})`;

                    // Apply styles
                    particle.style.width = `${size}px`;
                    particle.style.height = `${size}px`;
                    particle.style.left = `${posX}%`;
                    particle.style.top = `${posY}%`;
                    particle.style.backgroundColor = color;
                    particle.style.animationDelay = `${delay}s`;
                    particle.style.animationDuration = `${duration}s`;

                    // Random movement animation
                    const keyframes = `
                        @keyframes particleMove-${i} {
                            0% { transform: translate(0, 0); }
                            25% { transform: translate(${Math.random() * 100 - 50}px, ${Math.random() * 100 - 50}px); }
                            50% { transform: translate(${Math.random() * 100 - 50}px, ${Math.random() * 100 - 50}px); }
                            75% { transform: translate(${Math.random() * 100 - 50}px, ${Math.random() * 100 - 50}px); }
                            100% { transform: translate(0, 0); }
                        }
                    `;

                    const style = document.createElement('style');
                    style.innerHTML = keyframes;
                    document.head.appendChild(style);

                    particle.style.animationName = `particleMove-${i}`;

                    container.appendChild(particle);
                }
            }

            // City coordinates
            const cities = {
                new_york: { lat: 40.7128, lng: -74.0060, name: "New York" },
                los_angeles: { lat: 34.0522, lng: -118.2437, name: "Los Angeles" },
                mumbai: { lat: 19.0760, lng: 72.8777, name: "Mumbai" },
                shanghai: { lat: 31.2304, lng: 121.4737, name: "Shanghai" },
                rotterdam: { lat: 51.9244, lng: 4.4777, name: "Rotterdam" },
                singapore: { lat: 1.3521, lng: 103.8198, name: "Singapore" },
                london: { lat: 51.5074, lng: -0.1278, name: "London" },
                paris: { lat: 48.8566, lng: 2.3522, name: "Paris" },
                tokyo: { lat: 35.6762, lng: 139.6503, name: "Tokyo" },
                sydney: { lat: -33.8688, lng: 151.2093, name: "Sydney" },
                dubai: { lat: 25.2048, lng: 55.2708, name: "Dubai" },
                sao_paulo: { lat: -23.5505, lng: -46.6333, name: "São Paulo" }
            };

            // Route data (simplified for demo)
            const routeData = {
                // New York to London routes
                new_york_london: [
                    {
                        path: [
                            [40.7128, -74.0060],
                            [45.0, -40.0],
                            [51.5074, -0.1278]
                        ],
                        distance: 5585, // km
                        cost: 8500,
                        time: 7, // days
                        emissions: 1200, // kg CO2
                        currency: 'USD'
                    },
                    {
                        path: [
                            [40.7128, -74.0060],
                            [35.0, -20.0],
                            [51.5074, -0.1278]
                        ],
                        distance: 5850,
                        cost: 7800,
                        time: 8,
                        emissions: 1350,
                        currency: 'USD'
                    }
                ],
                // More routes would be defined here...
                mumbai_london: [
                    {
                        path: [
                            [19.0760, 72.8777],
                            [25.0, 60.0],
                            [35.0, 30.0],
                            [51.5074, -0.1278]
                        ],
                        distance: 7200,
                        cost: 9200,
                        time: 12,
                        emissions: 1800,
                        currency: 'USD'
                    },
                    {
                        path: [
                            [19.0760, 72.8777],
                            [15.0, 65.0],
                            [25.0, 30.0],
                            [51.5074, -0.1278]
                        ],
                        distance: 7500,
                        cost: 8700,
                        time: 13,
                        emissions: 1650,
                        currency: 'USD'
                    }
                ],
                shanghai_sydney: [
                    {
                        path: [
                            [31.2304, 121.4737],
                            [15.0, 130.0],
                            [-33.8688, 151.2093]
                        ],
                        distance: 7800,
                        cost: 10500,
                        time: 10,
                        emissions: 2100,
                        currency: 'USD'
                    },
                    {
                        path: [
                            [31.2304, 121.4737],
                            [20.0, 140.0],
                            [-10.0, 150.0],
                            [-33.8688, 151.2093]
                        ],
                        distance: 8200,
                        cost: 9800,
                        time: 11,
                        emissions: 1950,
                        currency: 'USD'
                    }
                ]
                // Add more route combinations as needed
            };

            // GSAP animations
            gsap.from("nav", {
                duration: 1,
                y: -50,
                opacity: 0,
                ease: "power3.out"
            });

            gsap.from(".form-card, .map-container", {
                duration: 1,
                y: 50,
                opacity: 0,
                stagger: 0.2,
                ease: "back.out(1.7)"
            });

            // Add this new event listener here
            document.getElementById('getStartedBtn').addEventListener('click', function() {
                // Set default values for demo
                document.getElementById('sourceLocation').value = "New York";
                document.getElementById('destinationLocation').value = "London";
                document.getElementById('quantity').value = "100";
                document.getElementById('weight').value = "500";
                document.getElementById('transportMode').value = "road";
                
                // Trigger form submission
                document.getElementById('supplyChainForm').dispatchEvent(new Event('submit'));
                
                // Scroll to the form section
                document.querySelector('.form-card').scrollIntoView({ behavior: 'smooth' });
            });

            gsap.from(".three-d-card", {
                scrollTrigger: {
                    trigger: ".three-d-card",
                    start: "top 80%",
                    toggleActions: "play none none none"
                },
                duration: 1,
                y: 50,
                opacity: 0,
                stagger: 0.2,
                ease: "back.out(1.7)"
            });

            // Parallax effect on scroll
            gsap.to(".parallax-layer", {
                scrollTrigger: {
                    scrub: true
                },
                y: (i, target) => -ScrollTrigger.maxScroll(window) * target.dataset.speed,
                ease: "none"
            });
        });
    </script>
</body>

</html>